[gcode_macro Purge]
description: Extrude into the purge bucket
variable_purge_length: 100
variable_purge_length_minimum: 60
gcode:



    SAVE_GCODE_STATE NAME=Purge_state
    {% if params.FV %} # ======= PARAM PURGE LENGTH ==============================
      {action_respond_info("PURGE: param PURGE_LENGTH provided")}
      {% set purge_len = params.FV|float %}
    
    {% else %} # ========================= USE CONFIG VARIABLE =============================
      {action_respond_info("PURGE: No toolmap or PURGE_LENGTH. Using default")}
      {% set purge_len = purge_length|float %}
    {% endif %}

    {% set purge_len = [purge_len,purge_length_minimum]|max %}
    {action_respond_info("PURGE: Purging %.2fmm of filament" % (purge_len|float))}
    {% set FE = params.new_filament_e_feedrate|default(240)|float %}
    
    purge_servo_OUT
    M106 S0
    G92 E0
    G1 E{purge_len} F{FE}
    G92 E0
    G1 E -0.4 F2000
    G92 E0
    M106 S255
    G4 P4000
    purge_servo_IN
    WIPE
    G4 P6000
    purge_servo_OUT
    M106 S0
    WIPE
    RESTORE_GCODE_STATE NAME=Purge_state


[gcode_macro purge_servo_IN]
gcode:
  SET_SERVO SERVO=purge_servo ANGLE=180

[gcode_macro purge_servo_OUT]
gcode:
  SET_SERVO SERVO=purge_servo ANGLE=10

[servo purge_servo]
pin: PC15
maximum_servo_angle: 180
maximum_pulse_width: 0.0023
minimum_pulse_width: 0.00053
