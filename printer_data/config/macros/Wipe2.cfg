[gcode_macro WIPE]
description: Wipe nozzle on silicone comb (Y-wipes + diagonal X during Y moves)

# Comb parameters
variable_comb_x: 17        ; X center of the comb
variable_comb_y: -17       ; Y center of the comb
variable_comb_z: 3.18      ; Z when touching the comb

# General parameters
variable_comb_z_lift: 5.0     ; Nozzle lift before/after wiping
variable_comb_width: 7.0      ; Full width of the comb (mm)
variable_comb_cycles_1: 4     ; Number of cycles in the first pass
variable_comb_cycles_2: 3     ; Number of zigzags in the second pass
variable_comb_offset_y: 1.0   ; Y offset for the second pass
variable_comb_zigzag_shift: 3 ; X shift per Y stroke (diagonal during wipe)

# Return to specified position
variable_return_x: 6.0
variable_return_y: -16.0

gcode:
    {% set half_width = comb_width / 2.0 %}
    
    G90 ; Absolute coordinates
    #G1 Z{comb_z_lift} F3000 ; Lift nozzle before moving
    G1 X{comb_x} Y{comb_y} F6000 ; Center of the comb
    #G1 Z{comb_z} F3000 ; Contact with the comb

    ; First pass: Straight Y-direction wipes
    G91 ; Relative coordinates
    {% for i in range(comb_cycles_1) %}
        G1 Y{half_width} F4500
        G1 Y-{half_width * 2} F4500
        G1 Y{half_width} F4500
    {% endfor %}

    ; Lift slightly and move Y offset
    G1 Z0.3 Y{comb_offset_y} F3000

    ; Second pass: Diagonal X shift DURING each Y move
    G91 ; Stay relative for smooth diagonal motion
    {% for cycle in range(comb_cycles_2) %}
        G1 X{comb_zigzag_shift} Y{half_width * 2} F4500           ; Forward Y + diagonal X
        G1 X{comb_zigzag_shift} Y-{half_width * 4} F4500          ; Long back Y + diagonal X  
        G1 X{comb_zigzag_shift} Y{half_width * 2} F4500           ; Return Y + diagonal X
    {% endfor %}

    ; Lift and return
    G90
    #G1 Z{comb_z_lift} F3000
    G1 X{return_x} Y{return_y} F6000
    G4 P500
